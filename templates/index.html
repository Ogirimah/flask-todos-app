<html>
	<head>
		<title>Todo App</title>
		<style>
			.hidden {
				display: none;
			}
			.hidden2 {
				display: none;
			}
			ul {
				list-style: none;
				padding: 0;
				margin: 0;
				width: 100%;
			}
			li {
				clear: both;
			}
			li button {
				-webkit-appearance: none;
				float: right;
				border: none;
				outline: none;
				color: red;
				cursor: pointer;
				font-size: 20px;
			}
			.lists-wrapper, .todos-wrapper {
				display: inline-block;
				vertical-align: top;
			}
		</style>
	</head>
	<body>
		<div class="lists-wrapper">
			<ul class="lists">
				{% for list in lists %}
				<li>
					<a href="/lists/{{ list.id }}"> {{ list.name }} </a>
				</li>
				{% endfor %}
			</ul>
		</div>
		<div class="todos-wrapper">
			<h4>{{ active_list.name }}</h4>
			<!-- Using 'form' to send data -->
			<!-- <form action='/todos/create' method='post'> -->

			<!-- Using 'AJAX' to send data -->
			<form id="form">
				<input type="text" name="description" id="description" />
				<input type="submit" value="create" />
			</form>

			<div class="hidden" id="error" style="color: red">
				Something Went Wrong!
			</div>
			<div class="hidden2" id="success" style="color: green">
				Todo item successfuly deleted
			</div>

			<ul id="todos">
				{% for todo in todos %}
				<li>
					<input
						type="checkbox"
						data-id="{{ todo.id }}"
						class="check-completed"
						{%
						if
						todo.completed
						%}
						checked
						{%
						endif
						%}
					/>{{ todo.description }}
					<button class="delete-button" data-id="{{ todo.id }}">&cross;</button>
				</li>
				{% endfor %}
			</ul>
		</div>
		<script>
			const deleteBtns = document.querySelectorAll(".delete-button");
			for (i = 0; i < deleteBtns.length; i++) {
				btn = deleteBtns[i];
				btn.onclick = function (e) {
					// const todoId = e.target.attributes["data-id"].value;
					const todoId = e.target.dataset["id"];
					console.log(todoId);
					fetch("todos/" + todoId + "/delete", {
						method: "DELETE",
					})
						.then(function () {
							const item = e.target.parentElement;
							item.remove();
						})
						.then(function () {
							document.getElementById("error").className = "hidden";
							document.getElementById("success").className = "";
						})
						.catch(function () {
							document.getElementById("error").className = "";
							document.getElementById("success").className = "hidden2";
						});
				};
			}

			const checkboxes = document.querySelectorAll(".check-completed");
			for (let i = 0; i < checkboxes.length; i++) {
				const checkbox = checkboxes[i];
				checkbox.onchange = function (e) {
					const new_completed = e.target.checked;
					const todoId = e.target.dataset["id"];
					fetch("/todos/" + todoId + "/set-completed", {
						method: "POST",
						body: JSON.stringify({ completed: new_completed }),
						headers: {
							"Content-Type": "application/json",
						},
					})
						.then(function () {
							document.getElementById("error").className = "hidden";
						})
						.catch(function () {
							document.getElementById("error").className = "";
						});
				};
			}
			const descInput = document.getElementById("description");
			document.getElementById("form").onsubmit = function (e) {
				e.preventDefault();
				const desc = descInput.value;
				descInput.value = "";
				fetch("/todos/create", {
					method: "POST",
					body: JSON.stringify({
						'description': desc,
						'list_id': {{ active_list.id }}
					}),
					headers: {
						"content-type": "application/json",
					}
				})
					.then(response => response.json())
					.then(json_response => {
						console.log(json_response);
						const li = document.createElement("li");
						const checkbox = document.createElement("input");
						checkbox.className = 'check-completed';
						checkbox.type = 'checkbox';
						checkbox.setAttribute('data-id', json_response.id);
						li.appendChild(checkbox);

						const text = document.createTextNode(' ' + json_response.description);
						li.appendChild(text);

						const deleteBtn = document.createElement('button');
						deleteBtn.className = 'delete-Button';
						deleteBtn.setAttribute('data-id', json_response.id);
						deleteBtn.innerHTML = '&cross;';
						li.appendChild(deleteBtn);

						document.getElementById("todos").appendChild(li);
						document.getElementById("error").className = "hidden";
					})
					.catch(function (error) {
						document.getElementById("error").className = "";
					});
			};
		</script>
	</body>
</html>
